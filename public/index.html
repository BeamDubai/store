<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ร้านขายสินค้า</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header style="background:linear-gradient(90deg,#3399ff,#0052cc);padding:18px 0 12px 0;box-shadow:0 2px 12px rgba(44,62,80,0.08);margin-bottom:24px;">
    <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:12px;">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h7.72a2 2 0 0 0 2-1.61l1.38-7.39H6"></path></svg>
        <span style="font-size:1.6em;font-weight:700;color:#fff;letter-spacing:1px;">Lazada Store</span>
      </div>
      <div style="display:flex;align-items:center;gap:16px;">
        <button id="logout-btn" style="background:linear-gradient(90deg,#ff5722,#ff9800);color:#fff;border:none;padding:8px 18px;border-radius:20px;font-size:1em;font-weight:600;cursor:pointer;">ล็อกเอ้าท์</button>
        <button id="cart-btn" style="background: none; border: none; cursor: pointer; position: relative;">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h7.72a2 2 0 0 0 2-1.61l1.38-7.39H6"></path></svg>
          <span id="cart-count" style="position: absolute; top: 0; right: 0; background: #ff5722; color: #fff; border-radius: 50%; padding: 2px 7px; font-size: 0.9em;">0</span>
        </button>
      </div>
    </div>
  </header>
  <!-- ลบหัวข้อสินค้าทั้งหมด -->
  <div id="product-list"></div>
  <div id="cart-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:#fff; border-radius:18px; padding:40px 32px; min-width:320px; max-width:90vw; box-shadow:0 4px 32px rgba(44,62,80,0.18);">
      <h2 style="margin-top:0;color:#3399ff;text-align:center;">รายการในตะกร้า</h2>
      <ul id="cart-list" style="padding-left:0; list-style:none;"></ul>
      <button onclick="closeCart()" style="margin-top:18px; width:100%;">ปิด</button>
    </div>
  </div>

  <script>
    document.getElementById('logout-btn').onclick = function() {
      localStorage.removeItem('user');
      window.location.href = '/login.html';
    };
    let products = [];
    fetch('/api/products')
      .then(res => res.json())
      .then(data => {
        products = data;
        const list = document.getElementById('product-list');
        // โหลดข้อมูลตะกร้าก่อนแสดงสินค้า
        fetch('/api/cart')
          .then(res => res.json())
          .then(cartData => {
            data.forEach(product => {
              const item = document.createElement('div');
              const cartItem = (cartData.cart || []).find(i => i.id === product.id);
              let qty = cartItem ? cartItem.qty : 0;
              item.innerHTML = `
                <img src="${product.image}" alt="${product.name}" style="width:120px;height:120px;object-fit:cover;border-radius:10px;margin-bottom:12px;border:1px solid #ececec;box-shadow:0 1px 6px rgba(44,62,80,0.08);">
                <h3 style='color:#222;font-size:1.2em;font-weight:600;text-align:center;margin:0 0 10px 0;'>${product.name}</h3>
                <p style='color:#ff5722;font-size:1.1em;font-weight:500;margin:0 0 16px 0;'>${product.price} บาท</p>
                <div id="qty-controls-${product.id}" style="display:${qty > 0 ? 'flex' : 'none'};justify-content:center;align-items:center;gap:8px;margin-top:8px;">
                  <button onclick="changeQty(${product.id},-1)" style='background:#eee;color:#222;border:none;padding:4px 12px;border-radius:16px;cursor:pointer;font-size:1em;'>-</button>
                  <span id="qty-${product.id}" style="min-width:24px;display:inline-block;text-align:center;">${qty}</span>
                  <button onclick="changeQty(${product.id},1)" style='background:#eee;color:#222;border:none;padding:4px 12px;border-radius:16px;cursor:pointer;font-size:1em;'>+</button>
                </div>
                <button id="ok-btn-${product.id}" onclick="okQty(${product.id})" style="background:#4caf50;color:#fff;border:none;padding:6px 16px;border-radius:16px;font-size:1em;font-weight:600;cursor:pointer;margin-top:8px;${qty > 0 ? '' : 'display:none;'}">ตกลง</button>
                <button id="add-btn-${product.id}" onclick="addToCart(${product.id})" style="background:linear-gradient(90deg,#3399ff,#0052cc);color:#fff;border:none;padding:8px 18px;border-radius:20px;font-size:1em;font-weight:600;cursor:pointer;margin-top:8px;${qty > 0 ? 'display:none;' : ''}">เพิ่มลงตะกร้า</button>
              `;
              item.style.background = '#fff';
              item.style.borderRadius = '12px';
              item.style.boxShadow = '0 2px 12px rgba(44,62,80,0.08)';
              item.style.padding = '24px 20px 18px 20px';
              item.style.width = '240px';
              item.style.display = 'flex';
              item.style.flexDirection = 'column';
              item.style.alignItems = 'center';
              item.style.transition = 'box-shadow 0.2s';
              item.style.border = '1px solid #ececec';
              item.onmouseover = function() { item.style.boxShadow = '0 6px 24px rgba(52,152,219,0.15)'; item.style.borderColor = '#3399ff'; };
              item.onmouseout = function() { item.style.boxShadow = '0 2px 12px rgba(44,62,80,0.08)'; item.style.borderColor = '#ececec'; };
              list.appendChild(item);
            });
          });
      });

    function addToCart(id) {
      fetch('/api/cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      }).then(() => {
        updateCartCount();
        // อัปเดตจำนวนและปุ่มในการ์ดสินค้า
        fetch('/api/cart')
          .then(res => res.json())
          .then(cartData => {
            const cartItem = (cartData.cart || []).find(i => i.id === id);
            document.getElementById('qty-' + id).textContent = cartItem ? cartItem.qty : 0;
            document.getElementById('qty-controls-' + id).style.display = 'flex';
            document.getElementById('add-btn-' + id).style.display = 'none';
            document.getElementById('ok-btn-' + id).style.display = '';
          });
      });
    }

    function updateCartCount() {
      fetch('/api/cart')
        .then(res => res.json())
        .then(data => {
          document.getElementById('cart-count').textContent = data.cart.length;
        });
    }
    updateCartCount();

    document.getElementById('cart-btn').onclick = function() {
      fetch('/api/cart')
        .then(res => res.json())
        .then(data => {
          const cartList = document.getElementById('cart-list');
          cartList.innerHTML = '';
          if (!data.cart || data.cart.length === 0) {
            cartList.innerHTML = '<li>ไม่มีสินค้าในตะกร้า</li>';
          } else {
            data.cart.forEach(item => {
              const product = products.find(p => p.id === item.id);
              cartList.innerHTML += `<li style='display:flex;justify-content:space-between;align-items:center;'>
                <span>${product ? product.name : 'สินค้า #' + item.id}</span>
                <div style='display:flex;align-items:center;gap:6px;'>
                  <button onclick="changeQty(${item.id},-1)" style='background:#eee;color:#222;border:none;padding:2px 10px;border-radius:12px;cursor:pointer;font-size:1.1em;'>-</button>
                  <span style='min-width:24px;display:inline-block;text-align:center;'>${item.qty}</span>
                  <button onclick="changeQty(${item.id},1)" style='background:#eee;color:#222;border:none;padding:2px 10px;border-radius:12px;cursor:pointer;font-size:1.1em;'>+</button>
                </div>
              </li>`;
            });
          }
          document.getElementById('cart-modal').style.display = 'flex';
        });
    };
    function changeQty(id, delta) {
      if (delta > 0) {
        fetch('/api/cart', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        }).then(() => {
          updateCartCount();
          fetch('/api/cart')
            .then(res => res.json())
            .then(cartData => {
              const cartItem = (cartData.cart || []).find(i => i.id === id);
              document.getElementById('qty-' + id).textContent = cartItem ? cartItem.qty : 0;
              if (cartItem && cartItem.qty > 0) {
                document.getElementById('qty-controls-' + id).style.display = 'flex';
                document.getElementById('add-btn-' + id).style.display = 'none';
                document.getElementById('ok-btn-' + id).style.display = '';
              } else {
                document.getElementById('qty-controls-' + id).style.display = 'none';
                document.getElementById('add-btn-' + id).style.display = '';
                document.getElementById('ok-btn-' + id).style.display = 'none';
              }
            });
        });
      } else {
        fetch('/api/cart/item', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        }).then(() => {
          updateCartCount();
          fetch('/api/cart')
            .then(res => res.json())
            .then(cartData => {
              const cartItem = (cartData.cart || []).find(i => i.id === id);
              document.getElementById('qty-' + id).textContent = cartItem ? cartItem.qty : 0;
              if (cartItem && cartItem.qty > 0) {
                document.getElementById('qty-controls-' + id).style.display = 'flex';
                document.getElementById('add-btn-' + id).style.display = 'none';
                document.getElementById('ok-btn-' + id).style.display = '';
              } else {
                document.getElementById('qty-controls-' + id).style.display = 'none';
                document.getElementById('add-btn-' + id).style.display = '';
                document.getElementById('ok-btn-' + id).style.display = 'none';
              }
            });
        });
      }
    }
    function okQty(id) {
      document.getElementById('qty-controls-' + id).style.display = 'none';
      document.getElementById('ok-btn-' + id).style.display = 'none';
      // ไม่ต้องซ่อน add-btn เพราะ qty > 0 อยู่แล้ว
    }
    function closeCart() {
      document.getElementById('cart-modal').style.display = 'none';
    }
  </script>
</body>
</html>
